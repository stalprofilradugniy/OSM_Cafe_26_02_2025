<!DOCTYPE html>
<html>
<head>
    <title>Поиск ближайших кафе</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #map { height: 400px; }
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <button onclick="getLocation()">Найти ближайшие кафе</button>
    <div id="results"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let userMarker;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Геолокация не поддерживается вашим браузером");
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            // Инициализация карты
            if (!map) {
                map = L.map('map').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            
            // Очистка предыдущих маркеров
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            userMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup('Ваше местоположение').openPopup();

            // Поиск кафе
            findNearbyCafes(lat, lon);
        }

        async function findNearbyCafes(lat, lon) {
            const radius = 1000; // Радиус поиска в метрах
            const overpassUrl = 'https://overpass-api.de/api/interpreter';
            
            const query = `
                [out:json];
                (
                    node["amenity"~"cafe|restaurant"](around:${radius},${lat},${lon});
                    way["amenity"~"cafe|restaurant"](around:${radius},${lat},${lon});
                );
                out center;
                `;

            try {
                const response = await fetch(overpassUrl, {
                    method: 'POST',
                    body: query
                });
                
                const data = await response.json();
                processResults(data.elements, lat, lon);
            } catch (error) {
                console.error('Ошибка:', error);
            }
        }

        function processResults(elements, userLat, userLon) {
            // Добавляем расчет расстояния
            const places = elements.map(element => {
                const lat = element.lat || element.center.lat;
                const lon = element.lon || element.center.lon;
                return {
                    name: element.tags.name || 'Название не указано',
                    lat: lat,
                    lon: lon,
                    distance: calculateDistance(userLat, userLon, lat, lon)
                };
            });

            // Сортировка по расстоянию
            places.sort((a, b) => a.distance - b.distance);
            
            // Берем топ-3
            const top3 = places.slice(0, 3);
            
            // Отображение результатов
            displayResults(top3);
            addMarkersToMap(top3);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Упрощенная формула расчета расстояния (в км)
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        function displayResults(places) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Ближайшие заведения:</h3>';
            
            places.forEach(place => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <strong>${place.name}</strong><br>
                    Расстояние: ${place.distance.toFixed(2)} км
                `;
                resultsDiv.appendChild(div);
            });
        }

        function addMarkersToMap(places) {
            places.forEach(place => {
                L.marker([place.lat, place.lon])
                    .addTo(map)
                    .bindPopup(place.name);
            });
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    alert("Разрешите доступ к геолокации");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Информация о местоположении недоступна");
                    break;
                case error.TIMEOUT:
                    alert("Время запроса геолокации истекло");
                    break;
            }
        }
    </script>
</body>
</html>
